version: '3.3'
services:
#  hamachi:
#    image: gfjardim/hamachi
#    network_mode: host
#    volumes:
#      - '$HOME/.config/hamachi:/config'
#    restart: always
#    environment:
#      - ACCOUNT=$HAM_USER
#      - NETWORK=$HAM_NETWORK
#      - PASS=$HAM_PASSWORD
#    privileged: true
  mmo-server:
    build: ./mmo-server/.
    command: 'bash -c "cd /release/ && ./mmo-server -a  0.0.0.0:8080"'
    ports:
      - '8010:8080/udp'
    environment:
      - VIRTUAL_PORT=8080
      - VIRTUAL_HOST=mmo.htpc
      - RUST_BACKTRACE=1
      - RUST_LOG=debug
    networks:
      app_net:
  mmo-server1:
    build: ./mmo-server/.
    command: 'bash -c "cd /release/ && ./mmo-server -a  0.0.0.0:8080"'
    ports:
      - '8011:8080/udp'
    environment:
      - VIRTUAL_PORT=8081
      - VIRTUAL_HOST=mmo.htpc
      - RUST_BACKTRACE=1
    networks:
      app_net:
  mmo-server2:
    build: ./mmo-server/.
    command: 'bash -c "cd /release/ && ./mmo-server -a  0.0.0.0:8080"'
    ports:
      - '8012:8080/udp'
    environment:
      - VIRTUAL_PORT=8082
      - VIRTUAL_HOST=mmo.htpc
      - RUST_BACKTRACE=1
    networks:
      app_net:
  mmo-server3:
    build: ./mmo-server/.
    command: 'bash -c "cd /release/ && ./mmo-server -a  0.0.0.0:8080"'
    ports:
      - '8013:8080/udp'
      - '8080'
    environment:
      - VIRTUAL_PORT=8083
      - VIRTUAL_HOST=mmo.htpc
      - RUST_BACKTRACE=1
  mmo-server4:
    build: ./mmo-server/.
    command: 'bash -c "cd /release/ && ./mmo-server -a  0.0.0.0:8080"'
    ports:
      - '8014:8080/udp'
      - '8080'
    environment:
      - VIRTUAL_PORT=8084
      - VIRTUAL_HOST=mmo.htpc
      - RUST_BACKTRACE=1
      - RUST_LOG=debug
    networks:
      app_net:
  web:
    build: ./web/.
    image: 'nginx:stable-alpine'
    ports:
      - '80:80'
    environment:
      - VIRTUAL_PORT=81
      - VIRTUAL_HOST=mmo.htpc
      - NGINX_HOST=_
      - NGINX_PORT=80
      - MMO_SERVER_PORT=8010-8020
      - MMO_CLIENT_PORT=8081
      - MMO_MUMBLE_PORT=8082
      - MURMUR_PORT=64738
    command: |
      /bin/sh -c ' envsubst < /usr/share/nginx/www/index.html > /usr/share/nginx/html/index.html &&  envsubst < /etc/nginx/conf.d/web.template > /etc/nginx/conf.d/default.conf &&  nginx -g "daemon off;"'
    depends_on:
      - mmo-server
    networks:
      app_net:
networks:
  app_net:
    ipam:
      driver: default
volumes:
  src: null
